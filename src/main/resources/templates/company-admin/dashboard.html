<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard - kanna.io</title>
    <link rel="stylesheet" th:href="@{/css/netflix.css}">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 8px 0;
            color: #aaa;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #e50914;
            margin: 0;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }
    </style>
</head>
<body class="nf-body">
<div class="nf-header">
    <div style="display: flex; align-items: center; gap: 12px;">
        <span style="color: #e50914; font-size: 32px;">k</span>
        <span style="font-size: 24px; font-weight: 600;">kanna.io - <span th:text="${company}">Company</span> Admin</span>
    </div>
    <div>
        <a class="nf-button nf-secondary" th:href="@{/logout}">Logout</a>
    </div>
</div>

<div class="nf-container">
    <div style="margin-bottom: 24px;">
        <h1 style="margin: 0 0 8px 0; font-size: 32px;">Welcome, <span th:text="${#authentication.name}">Admin</span>!</h1>
        <p style="color: #aaa; margin: 0;">Manage end users and SSO configuration for <strong th:text="${company}">your company</strong>.</p>
    </div>

    <div th:if="${error != null or param.error != null}" style="background:#b81d24;color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:20px;">
        <span th:if="${error != null}" th:text="${error}"></span>
        <span th:if="${param.error != null}">[[${param.error[0]}]]</span>
    </div>
    <div th:if="${success != null or param.success != null}" style="background:#2ecc71;color:#fff;padding:12px 16px;border-radius:6px;margin-bottom:20px;">
        <span th:if="${success != null}" th:text="${success}"></span>
        <span th:if="${param.success != null}">[[${param.success[0]}]]</span>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Users</h3>
            <p class="stat-value" th:text="${users != null ? users.size() : 0}">0</p>
        </div>
        <div class="stat-card">
            <h3>End Users</h3>
            <p class="stat-value" style="color: #2ecc71;" th:text="${users != null ? (#lists.size(users.?[userRole.name() == 'END_USER'])) : 0}">0</p>
        </div>
        <div class="stat-card">
            <h3>Admins</h3>
            <p class="stat-value" style="color: #ff9800;" th:text="${users != null ? (#lists.size(users.?[userRole.name() == 'CUSTOMER_ADMIN'])) : 0}">0</p>
        </div>
    </div>

    <div class="nf-section">
        <div class="section-header">
            <h2>End User Management</h2>
            <a class="nf-button" th:href="@{'/' + ${company} + '/customer-admin/users/new'}">+ Add End User</a>
        </div>
        <p style="color: #aaa; margin-bottom: 20px;">Create and manage end users for your organization.</p>
        <table class="nf-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Role</th>
                <th>Enabled</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
                <tr th:if="${users == null or users.isEmpty()}">
                    <td colspan="8" style="text-align: center; color: #aaa;">No users found. Click "Add End User" to create one.</td>
                </tr>
                <tr th:each="u : ${users}">
                    <td th:text="${u.id}"></td>
                    <td th:text="${u.username}"></td>
                    <td th:text="${u.email}"></td>
                    <td th:text="${u.firstName}"></td>
                    <td th:text="${u.lastName}"></td>
                    <td>
                        <span th:switch="${u.userRole}">
                            <span th:case="CUSTOMER_ADMIN" style="color: #ff9800;">Customer Admin</span>
                            <span th:case="END_USER" style="color: #2ecc71;">End User</span>
                            <span th:case="*" th:text="${u.userRole}"></span>
                        </span>
                    </td>
                    <td>
                        <span th:if="${u.enabled == true}" style="color: #2ecc71;">Yes</span>
                        <span th:if="${u.enabled == false}" style="color: #b81d24;">No</span>
                    </td>
                    <td>
                        <a class="nf-button nf-secondary" th:href="@{'/' + ${company} + '/customer-admin/users/' + ${u.id} + '/edit'}" style="margin-right: 8px; text-decoration: none; display: inline-block; padding: 6px 12px; font-size: 14px;">Edit</a>
                        <form th:action="@{'/' + ${company} + '/customer-admin/users/' + ${u.id} + '/delete'}" method="post" style="display:inline;" onsubmit="return confirm('Delete this user?');">
                            <button class="nf-button nf-danger" type="submit" style="padding: 6px 12px; font-size: 14px;">Delete</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="nf-section">
        <div class="section-header">
            <h2>SSO Configuration</h2>
        </div>
        <p style="color: #aaa; margin-bottom: 20px;">Configure SSO settings for your organization. This allows your end users to sign in using your identity provider.</p>
        
        <!-- SSO Toggle -->
        <div class="nf-card" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                    <h3 style="margin: 0 0 8px 0; color: #fff;">SSO Status</h3>
                    <p style="margin: 0; color: #aaa; font-size: 14px;">
                        When enabled, users will see SSO login option on the password page.
                    </p>
                </div>
                <form th:action="@{'/' + ${company} + '/customer-admin/sso/toggle'}" method="post" style="display: inline;">
                    <input type="hidden" name="enabled" th:value="${!config.ssoEnabled}"/>
                    <button type="submit" 
                            class="nf-button" 
                            th:classappend="${config.ssoEnabled} ? 'nf-success' : 'nf-secondary'"
                            th:text="${config.ssoEnabled} ? 'Disable SSO' : 'Enable SSO'">
                        Toggle SSO
                    </button>
                </form>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="color: #aaa; font-size: 14px;">Current Status:</span>
                <span th:if="${config.ssoEnabled}" style="color: #2ecc71; font-weight: 600;">ENABLED</span>
                <span th:unless="${config.ssoEnabled}" style="color: #b81d24; font-weight: 600;">DISABLED</span>
            </div>
        </div>
        
        <!-- SSO Providers Management -->
        <div class="nf-section" th:if="${config.ssoEnabled}">
            <div class="section-header">
                <div>
                    <h2>SSO Providers</h2>
                    <p style="color: #aaa; margin: 8px 0 0 0; font-size: 14px;">Manage multiple SSO providers for your organization. You can add providers with different protocols (OIDC, SAML, JWT).</p>
                </div>
                <div class="nf-actions">
                    <button class="nf-button" onclick="openAddProviderModal()">+ Add SSO Provider</button>
                    <button class="nf-button nf-secondary" onclick="loadProviders()">Refresh</button>
                </div>
            </div>
            
            <table class="nf-table" id="providersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${ssoProviders == null or ssoProviders.isEmpty()}">
                        <td colspan="5" style="text-align: center; color: #aaa; padding: 20px;">No SSO providers configured yet. Click "Add SSO Provider" to create one.</td>
                    </tr>
                    <tr th:each="provider : ${ssoProviders}">
                        <td th:text="${provider.id}">1</td>
                        <td th:text="${provider.name}">Provider Name</td>
                        <td><span class="nf-badge" th:text="${provider.type}">OIDC</span></td>
                        <td>
                            <span th:if="${provider.active}" style="color: #2ecc71; font-weight: 600;">ACTIVE</span>
                            <span th:unless="${provider.active}" style="color: #aaa;">INACTIVE</span>
                        </td>
                        <td>
                            <button class="nf-button nf-success" th:if="${!provider.active}" 
                                    th:onclick="'activateProvider(' + ${provider.id} + ')'" 
                                    style="margin-right: 8px;">Activate</button>
                            <button class="nf-button nf-secondary" th:if="${provider.active}" 
                                    th:onclick="'deactivateProvider(' + ${provider.id} + ')'" 
                                    style="margin-right: 8px;">Deactivate</button>
                            <button class="nf-button nf-secondary" 
                                    th:onclick="'editProvider(' + ${provider.id} + ')'" 
                                    style="margin-right: 8px;">Edit</button>
                            <button class="nf-button nf-danger" 
                                    th:onclick="'deleteProvider(' + ${provider.id} + ')'" 
                                    style="margin-right: 8px;">Delete</button>
                            <button class="nf-button" 
                                    th:onclick="'testProvider(' + ${provider.id} + ')'">Test</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit SSO Provider Modal -->
<div id="addSsoModal" class="nf-modal" style="display: none;">
    <div class="nf-modal-content" style="max-width: 960px; max-height: 92vh; overflow-y: auto; padding: 0; background: #111;">
        <div class="nf-modal-header" style="padding: 24px 28px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 id="modalTitle" style="margin: 0; font-size: 26px; font-weight: 700;">Add SSO Provider</h3>
                <p style="margin: 6px 0 0 0; color: #aaa; font-size: 14px;">Configure OIDC, SAML, or JWT flows for this tenant. Fields change automatically based on the provider type.</p>
            </div>
            <button class="nf-button nf-secondary" onclick="closeAddProviderModal()" style="padding: 8px 16px; font-size: 20px; line-height: 1;">×</button>
        </div>
        <div class="nf-modal-body" style="padding: 24px 28px;">
            <form id="providerForm" onsubmit="saveProvider(event)" style="display: flex; flex-direction: column; gap: 24px;">
                <input type="hidden" id="saveProviderId" value="">

                <div class="nf-card" style="padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid #282828;">
                    <h4 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #fff;">Provider Details</h4>
                    <p style="margin: 0 0 16px 0; color: #b5b5b5; font-size: 14px;">Give the integration a clear name and choose the technology type that matches your identity provider.</p>
                    <label>Provider Name *</label>
                    <input type="text" id="newProviderName" required placeholder="MyCompany Okta / Azure AD / Auth0 / miniOrange" style="margin-bottom: 16px;">
                    <label>Type *</label>
                    <select id="newProviderType" required onchange="onProviderTypeChange(this.value)" style="margin-bottom: 8px;">
                        <option value="">Select Type</option>
                        <option value="OIDC">OIDC / OAuth2</option>
                        <option value="SAML">SAML</option>
                        <option value="JWT">JWT</option>
                    </select>
                    <small style="color: #888; display: block;">Choose the protocol supported by the identity provider you are configuring.</small>
                </div>

                <div id="newOidcFields" class="nf-card" style="display: none; padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid #282828;">
                    <h4 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #fff;">OIDC / OAuth2 Configuration</h4>
                    <p style="margin: 0 0 20px 0; color: #b5b5b5; font-size: 14px;">Use the discovery URL to auto-import settings or enter everything manually.</p>

                    <div class="nf-card" style="background: rgba(229,9,20,0.06); border: 1px solid rgba(229,9,20,0.35); padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 8px;">Option 1 — Import from Discovery URL (Recommended)</div>
                        <label>OIDC Discovery URL</label>
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                            <input type="text" id="newOidcDiscoveryUrl" placeholder="https://kanna.xecurify.com/moas/discovery/v2.0/{CLIENT_ID}/.well-known/openid-configuration" style="flex: 1;">
                            <button type="button" class="nf-button nf-secondary" onclick="importOidcDiscoveryModal()">Import from Discovery URL</button>
                        </div>
                        <small style="color: #e8e8e8; display: block;">miniOrange: Use your discovery URL with the Client ID, e.g., <code style="background:#1f1f1f; padding:2px 6px; border-radius:4px;">https://kanna.xecurify.com/moas/discovery/v2.0/{CLIENT_ID}/.well-known/openid-configuration</code></small>
                        <small style="color: #f5c542; display: block; margin-top: 8px;">⚠️ After importing, make sure the Redirect URI matches exactly what you configured in miniOrange (typically <code style="background:#1f1f1f; padding:2px 6px; border-radius:4px;">http://localhost:8080/sso/oauth2/callback</code>).</small>
                    </div>

                    <div style="text-align: center; color: #777; margin: 12px 0;">— or —</div>

                    <div class="nf-card" style="padding: 16px; background: rgba(255,255,255,0.02); border: 1px dashed #333;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 12px;">Option 2 — Enter Manually</div>
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                            <div>
                                <label>Client ID *</label>
                                <input type="text" id="newOidcClientId" placeholder="Enter OIDC Client ID">
                            </div>
                            <div>
                                <label>Client Secret *</label>
                                <input type="password" id="newOidcClientSecret" placeholder="Enter OIDC Client Secret">
                            </div>
                            <div>
                                <label>Redirect URI (Callback URL) *</label>
                                <input type="text" id="newOidcRedirectUri" placeholder="http://localhost:8080/sso/oauth2/callback">
                                <small style="color: #f5c542; display: block;">⚠️ Must match exactly what is configured in the IdP.</small>
                            </div>
                            <div>
                                <label>Issuer URL</label>
                                <input type="text" id="newOidcIssuerUri" placeholder="https://kanna.xecurify.com/moas/discovery/v2.0/{CLIENT_ID}">
                            </div>
                            <div>
                                <label>Scopes</label>
                                <input type="text" id="newOidcScopes" placeholder="openid profile email" value="openid profile email">
                            </div>
                        </div>
                        <div style="margin-top: 16px; display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                            <div>
                                <label>Authorization Endpoint (optional)</label>
                                <input type="text" id="newOidcAuthz" placeholder="Enter Authorization Endpoint">
                            </div>
                            <div>
                                <label>Token Endpoint (optional)</label>
                                <input type="text" id="newOidcToken" placeholder="Enter Token Endpoint">
                            </div>
                            <div>
                                <label>User Info Endpoint (optional)</label>
                                <input type="text" id="newOidcUserInfo" placeholder="Enter User Info Endpoint">
                            </div>
                            <div>
                                <label>Logout Endpoint (optional)</label>
                                <input type="text" id="newOidcLogout" placeholder="Enter Logout Endpoint">
                            </div>
                        </div>
                        <small style="color: #888; display: block; margin-top: 12px;">If the endpoints are left blank they will be auto-detected from the Issuer or discovery document.</small>
                    </div>
                </div>

                <div id="newSamlFields" class="nf-card" style="display: none; padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid #282828;">
                    <h4 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #fff;">SAML Configuration</h4>
                    <p style="margin: 0 0 20px 0; color: #b5b5b5; font-size: 14px;">Use any one of the options below to configure SAML for this provider.</p>

                    <div class="nf-card" style="background: rgba(229,9,20,0.06); border: 1px solid rgba(229,9,20,0.35); padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 8px;">Option 1 — Import from Metadata URL</div>
                        <label>Metadata URL</label>
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                            <input type="text" id="newSamlMetadataUrl" placeholder="https://idp.example.com/metadata" style="flex: 1;">
                            <button type="button" class="nf-button nf-secondary" onclick="importSamlMetadataUrlModal()">Import</button>
                        </div>
                        <small style="color: #e8e8e8; display: block;">Paste the metadata URL exposed by the IdP. The entity ID, SSO URL, and certificate will be auto-filled.</small>
                    </div>

                    <div style="text-align: center; color: #777; margin: 12px 0;">— or —</div>

                    <div class="nf-card" style="padding: 16px; background: rgba(255,255,255,0.02); border: 1px dashed #333; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 8px;">Option 2 — Upload Metadata XML</div>
                        <label class="nf-button" style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                            Upload XML File
                            <input type="file" accept=".xml" style="display: none" onchange="importSamlMetadataFileModal(this)">
                        </label>
                        <small style="color: #888; display: block; margin-top: 8px;">Upload the XML metadata file exported from your IdP. We will extract the entity ID, login URL, certificate, and store the full XML.</small>
                    </div>

                    <div style="text-align: center; color: #777; margin: 12px 0;">— or —</div>

                    <div style="display: grid; gap: 16px;">
                        <div style="font-weight: 600; color: #fff;">Option 3 — Enter Manually</div>
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                            <div>
                                <label>SAML Entity ID</label>
                                <input type="text" id="newSamlEntityId" placeholder="Enter SAML Entity ID">
                            </div>
                            <div>
                                <label>SAML SSO URL</label>
                                <input type="text" id="newSamlSsoUrl" placeholder="Enter SAML Login URL">
                            </div>
                        </div>
                        <div>
                            <label>SAML X509 Certificate (PEM)</label>
                            <textarea id="newSamlX509Cert" rows="5" placeholder="-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----"></textarea>
                        </div>
                        <div>
                            <label>Full SAML Metadata XML (optional)</label>
                            <textarea id="newSamlMetadataXml" rows="4" placeholder="Paste full metadata XML if provided"></textarea>
                        </div>
                    </div>
                </div>

                <div id="newJwtFields" class="nf-card" style="display: none; padding: 20px; background: rgba(255,255,255,0.03); border: 1px solid #282828;">
                    <h4 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600; color: #fff;">JWT Configuration</h4>
                    <p style="margin: 0 0 16px 0; color: #b5b5b5; font-size: 14px;">Configure JWT SSO (miniOrange style) or token validation settings.</p>

                    <div class="nf-card" style="background: rgba(229,9,20,0.06); border: 1px solid rgba(229,9,20,0.35); padding: 16px; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 12px;">JWT Login Flow — Required for miniOrange SSO</div>
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
                            <div>
                                <label>SSO URL *</label>
                                <input type="text" id="newJwtSsoUrl" placeholder="https://kanna.xecurify.com/moas/idp/jwtsso/379412">
                            </div>
                            <div>
                                <label>Client ID *</label>
                                <input type="text" id="newJwtClientId" placeholder="Paste JWT Client ID">
                            </div>
                            <div>
                                <label>Client Secret</label>
                                <input type="password" id="newJwtClientSecret" placeholder="Paste JWT Client Secret">
                            </div>
                            <div>
                                <label>Redirect URI (Callback URL)</label>
                                <input type="text" id="newJwtRedirectUri" placeholder="http://localhost:8080/sso/jwt/callback">
                                <small style="color: #f5c542; display: block;">Required for JWT login flow. Defaults to <code style="background:#1f1f1f; padding:2px 6px; border-radius:4px;">http://localhost:8080/sso/jwt/callback</code>.</small>
                            </div>
                        </div>
                    </div>

                    <div class="nf-card" style="padding: 16px; background: rgba(255,255,255,0.02); border: 1px dashed #333; margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 12px;">Optional: Certificate for Token Verification</div>
                        <textarea id="newJwtCertificate" rows="4" placeholder="-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----"></textarea>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px;">
                            <button type="button" class="nf-button nf-secondary" onclick="document.getElementById('newJwtCertUpload').click()">Upload Certificate</button>
                            <input id="newJwtCertUpload" type="file" accept=".pem,.crt" style="display:none" onchange="uploadJwtCertificateModal(this)">
                            <small style="color: #888;">Upload a PEM certificate to validate JWT signatures. If omitted, tokens will be accepted without signature verification.</small>
                        </div>
                    </div>

                    <div class="nf-card" style="padding: 16px; background: rgba(255,255,255,0.02); border: 1px dashed #333;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 12px;">Optional: Additional JWT Settings (for Testing/API)</div>
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                            <div>
                                <label>JWKS URI</label>
                                <input type="text" id="newJwtJwksUri" placeholder="https://example.com/.well-known/jwks.json">
                            </div>
                            <div>
                                <label>Issuer</label>
                                <input type="text" id="newJwtIssuer" placeholder="Enter expected issuer">
                            </div>
                            <div>
                                <label>Audience</label>
                                <input type="text" id="newJwtAudience" placeholder="Enter audience claim">
                            </div>
                            <div>
                                <label>Header Name</label>
                                <input type="text" id="newJwtHeaderName" placeholder="Authorization">
                            </div>
                        </div>
                        <small style="color: #888; display: block; margin-top: 12px;">These settings control how incoming JWT tokens are validated when using API-based authentication flows.</small>
                    </div>
                </div>

                <div class="nf-actions" style="margin-top: 8px; padding-top: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="nf-button nf-secondary" onclick="closeAddProviderModal()">Close</button>
                    <button type="submit" class="nf-button">Save Provider</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const companyName = '[[${company}]]';
    
    function openAddProviderModal() {
        document.getElementById('addSsoModal').style.display = 'flex';
        document.getElementById('modalTitle').textContent = 'Add SSO Provider';
        document.getElementById('saveProviderId').value = '';
        document.getElementById('providerForm').reset();
        document.getElementById('newOidcFields').style.display = 'none';
        document.getElementById('newSamlFields').style.display = 'none';
        document.getElementById('newJwtFields').style.display = 'none';
        ['newSamlX509Cert','newSamlMetadataXml','newJwtCertificate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
    }
    
    function closeAddProviderModal() {
        document.getElementById('addSsoModal').style.display = 'none';
    }
    
    function onProviderTypeChange(type) {
        document.getElementById('newOidcFields').style.display = type === 'OIDC' ? 'block' : 'none';
        document.getElementById('newSamlFields').style.display = type === 'SAML' ? 'block' : 'none';
        document.getElementById('newJwtFields').style.display = type === 'JWT' ? 'block' : 'none';
    }
    
    async function loadProviders() {
        const tbody = document.querySelector('#providersTable tbody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>';
        try {
            const res = await fetch(`/${companyName}/customer-admin/sso/providers`);
            if (!res.ok) throw new Error('Failed to load providers');
            const list = await res.json();
            tbody.innerHTML = '';
            if (!Array.isArray(list) || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa; padding: 20px;">No SSO providers configured yet.</td></tr>';
                return;
            }
            list.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.name || ''}</td>
                    <td><span class="nf-badge">${p.type || ''}</span></td>
                    <td>
                        ${p.active ? '<span style="color: #2ecc71; font-weight: 600;">ACTIVE</span>' : '<span style="color: #aaa;">INACTIVE</span>'}
                    </td>
                    <td>
                        ${!p.active ? `<button class="nf-button nf-success" onclick="activateProvider(${p.id})" style="margin-right: 8px;">Activate</button>` : ''}
                        ${p.active ? `<button class="nf-button nf-secondary" onclick="deactivateProvider(${p.id})" style="margin-right: 8px;">Deactivate</button>` : ''}
                        <button class="nf-button nf-secondary" onclick="editProvider(${p.id})" style="margin-right: 8px;">Edit</button>
                        <button class="nf-button nf-danger" onclick="deleteProvider(${p.id})" style="margin-right: 8px;">Delete</button>
                        <button class="nf-button" onclick="testProvider(${p.id})">Test</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #b81d24; padding: 20px;">Error: ${e.message}</td></tr>`;
        }
    }
    
    async function saveProvider(event) {
        event.preventDefault();
        const id = document.getElementById('saveProviderId').value;
        const type = document.getElementById('newProviderType').value;
        const name = document.getElementById('newProviderName').value.trim();
        
        if (!type || !name) {
            alert('Provider name and type are required');
            return;
        }
        
        const body = { name, type };
        
        // Add protocol-specific fields
        if (type === 'OIDC') {
            body.oidcClientId = document.getElementById('newOidcClientId').value || '';
            body.oidcClientSecret = document.getElementById('newOidcClientSecret').value || '';
            body.oidcIssuerUri = document.getElementById('newOidcIssuerUri').value || '';
            body.oidcRedirectUri = document.getElementById('newOidcRedirectUri').value || '';
            body.oidcScopes = document.getElementById('newOidcScopes').value || 'openid profile email';
            body.oidcAuthorizationEndpoint = document.getElementById('newOidcAuthz').value || '';
            body.oidcTokenEndpoint = document.getElementById('newOidcToken').value || '';
            body.oidcUserInfoEndpoint = document.getElementById('newOidcUserInfo').value || '';
            body.oidcLogoutEndpoint = document.getElementById('newOidcLogout').value || '';
        } else if (type === 'SAML') {
            body.samlEntityId = document.getElementById('newSamlEntityId').value || '';
            body.samlSsoUrl = document.getElementById('newSamlSsoUrl').value || '';
            body.samlX509Cert = document.getElementById('newSamlX509Cert').value || '';
            body.samlMetadataUrl = document.getElementById('newSamlMetadataUrl').value || '';
            body.samlMetadataXml = document.getElementById('newSamlMetadataXml').value || '';
        } else if (type === 'JWT') {
            body.jwtSsoUrl = document.getElementById('newJwtSsoUrl').value || '';
            body.jwtClientId = document.getElementById('newJwtClientId').value || '';
            body.jwtClientSecret = document.getElementById('newJwtClientSecret').value || '';
            body.jwtRedirectUri = document.getElementById('newJwtRedirectUri').value || '';
            body.jwtIssuer = document.getElementById('newJwtIssuer').value || '';
            body.jwtAudience = document.getElementById('newJwtAudience').value || '';
            body.jwtJwksUri = document.getElementById('newJwtJwksUri').value || '';
            body.jwtHeaderName = document.getElementById('newJwtHeaderName').value || '';
            body.jwtCertificate = document.getElementById('newJwtCertificate').value || '';
        }
        
        const url = id ? `/${companyName}/customer-admin/sso/providers/${id}` : `/${companyName}/customer-admin/sso/providers`;
        const method = id ? 'PUT' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (res.ok) {
                const result = await res.json();
                alert('Provider saved successfully');
                closeAddProviderModal();
                loadProviders();
            } else {
                const errorData = await res.json().catch(() => ({ error: 'Failed to save provider' }));
                alert(errorData.error || `Failed to save provider (Status: ${res.status})`);
            }
        } catch (e) {
            alert('Error saving provider: ' + e.message);
            console.error('Provider save error:', e);
        }
    }
    
    async function activateProvider(id) {
        const res = await fetch(`/${companyName}/customer-admin/sso/providers/${id}/activate`, { method: 'POST' });
        if (res.ok) {
            loadProviders();
        } else {
            alert('Failed to activate provider');
        }
    }
    
    async function deactivateProvider(id) {
        const res = await fetch(`/${companyName}/customer-admin/sso/providers/${id}/deactivate`, { method: 'POST' });
        if (res.ok) {
            loadProviders();
        } else {
            alert('Failed to deactivate provider');
        }
    }
    
    async function editProvider(id) {
        const res = await fetch(`/${companyName}/customer-admin/sso/providers/${id}`);
        if (!res.ok) {
            alert('Failed to load provider');
            return;
        }
        const p = await res.json();
        
        document.getElementById('addSsoModal').style.display = 'flex';
        document.getElementById('modalTitle').textContent = 'Edit SSO Provider';
        document.getElementById('saveProviderId').value = p.id;
        document.getElementById('newProviderName').value = p.name || '';
        const normalizedType = p.type ? p.type.toUpperCase() : 'OIDC';
        document.getElementById('newProviderType').value = normalizedType;
        onProviderTypeChange(normalizedType);
        
        if (normalizedType === 'OIDC') {
            document.getElementById('newOidcClientId').value = p.oidcClientId || '';
            document.getElementById('newOidcClientSecret').value = p.oidcClientSecret || '';
            document.getElementById('newOidcIssuerUri').value = p.oidcIssuerUri || '';
            document.getElementById('newOidcRedirectUri').value = p.oidcRedirectUri || '';
            document.getElementById('newOidcScopes').value = p.oidcScopes || '';
            document.getElementById('newOidcAuthz').value = p.oidcAuthorizationEndpoint || '';
            document.getElementById('newOidcToken').value = p.oidcTokenEndpoint || '';
            document.getElementById('newOidcUserInfo').value = p.oidcUserInfoEndpoint || '';
            document.getElementById('newOidcLogout').value = p.oidcLogoutEndpoint || '';
        } else if (normalizedType === 'SAML') {
            document.getElementById('newSamlEntityId').value = p.samlEntityId || '';
            document.getElementById('newSamlSsoUrl').value = p.samlSsoUrl || '';
            document.getElementById('newSamlX509Cert').value = p.samlX509Cert || '';
            document.getElementById('newSamlMetadataUrl').value = p.samlMetadataUrl || '';
            document.getElementById('newSamlMetadataXml').value = p.samlMetadataXml || '';
        } else if (normalizedType === 'JWT') {
            document.getElementById('newJwtSsoUrl').value = p.jwtSsoUrl || '';
            document.getElementById('newJwtClientId').value = p.jwtClientId || '';
            document.getElementById('newJwtClientSecret').value = p.jwtClientSecret || '';
            document.getElementById('newJwtRedirectUri').value = p.jwtRedirectUri || '';
            document.getElementById('newJwtIssuer').value = p.jwtIssuer || '';
            document.getElementById('newJwtAudience').value = p.jwtAudience || '';
            document.getElementById('newJwtJwksUri').value = p.jwtJwksUri || '';
            document.getElementById('newJwtHeaderName').value = p.jwtHeaderName || '';
            document.getElementById('newJwtCertificate').value = p.jwtCertificate || '';
        }
    }
    
    async function deleteProvider(id) {
        if (!confirm('Delete this provider?')) return;
        const res = await fetch(`/${companyName}/customer-admin/sso/providers/${id}`, { method: 'DELETE' });
        if (res.ok) {
            loadProviders();
        } else {
            alert('Failed to delete provider');
        }
    }
    
    async function testProvider(id) {
        window.location.href = `/${companyName}/customer-admin/sso/providers/${id}/test`;
    }
    
    async function importOidcDiscoveryModal() {
        const url = document.getElementById('newOidcDiscoveryUrl').value.trim();
        if (!url) {
            alert('Please enter a discovery URL to import.');
            return;
        }
        try {
            const res = await fetch(`/api/sso/providers/oidc/discovery?url=${encodeURIComponent(url)}`);
            if (!res.ok) {
                alert('Failed to import the discovery document. Ensure the URL is reachable.');
                return;
            }
            const data = await res.json();
            if (data.oidcIssuerUri) document.getElementById('newOidcIssuerUri').value = data.oidcIssuerUri;
            if (data.oidcAuthorizationEndpoint) document.getElementById('newOidcAuthz').value = data.oidcAuthorizationEndpoint;
            if (data.oidcTokenEndpoint) document.getElementById('newOidcToken').value = data.oidcTokenEndpoint;
            if (data.oidcUserInfoEndpoint) document.getElementById('newOidcUserInfo').value = data.oidcUserInfoEndpoint;
            if (data.oidcLogoutEndpoint) document.getElementById('newOidcLogout').value = data.oidcLogoutEndpoint;
            if (data.oidcScopes) document.getElementById('newOidcScopes').value = data.oidcScopes;
            alert('Discovery document imported successfully. Review the values before saving.');
        } catch (e) {
            alert('Error importing discovery document: ' + e.message);
        }
    }

    async function importSamlMetadataUrlModal() {
        const url = document.getElementById('newSamlMetadataUrl').value.trim();
        if (!url) {
            alert('Please enter a metadata URL');
            return;
        }
        try {
            const res = await fetch(`/api/sso/providers/metadata/fetch?url=${encodeURIComponent(url)}`);
            if (res.ok) {
                const data = await res.json();
                document.getElementById('newSamlEntityId').value = data.samlEntityId || '';
                document.getElementById('newSamlSsoUrl').value = data.samlSsoUrl || '';
                document.getElementById('newSamlX509Cert').value = data.samlX509Cert || '';
                if (data.samlMetadataXml) document.getElementById('newSamlMetadataXml').value = data.samlMetadataXml;
                alert('SAML metadata imported successfully!');
            } else {
                alert('Failed to import SAML metadata');
            }
        } catch (e) {
            alert('Error importing SAML metadata: ' + e.message);
        }
    }
    
    async function importSamlMetadataFileModal(input) {
        if (!input.files || !input.files[0]) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);
        try {
            const res = await fetch('/api/sso/providers/metadata/upload', {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('newSamlEntityId').value = data.samlEntityId || '';
                document.getElementById('newSamlSsoUrl').value = data.samlSsoUrl || '';
                document.getElementById('newSamlX509Cert').value = data.samlX509Cert || '';
                if (data.samlMetadataXml) document.getElementById('newSamlMetadataXml').value = data.samlMetadataXml;
                alert('SAML metadata imported successfully!');
            } else {
                alert('Failed to import SAML metadata');
            }
        } catch (e) {
            alert('Error importing SAML metadata: ' + e.message);
        }
    }

    function uploadJwtCertificateModal(input) {
        if (!input.files || !input.files[0]) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);
        fetch('/api/sso/providers/jwt/upload-cert', {
            method: 'POST',
            body: formData
        }).then(res => {
            if (!res.ok) throw new Error('Upload failed');
            return res.json();
        }).then(data => {
            document.getElementById('newJwtCertificate').value = data.jwtCertificate || '';
            alert('Certificate uploaded successfully.');
        }).catch(err => {
            alert('Failed to upload certificate: ' + err.message);
        }).finally(() => {
            input.value = '';
        });
    }
    
    // Load providers on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadProviders();
    });
</script>
</body>
</html>
